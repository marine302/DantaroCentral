<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dantaro Central - ì‹¤ì‹œê°„ ì°¨ìµê±°ë˜ ëŒ€ì‹œë³´ë“œ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="/static/css/dashboard.css">
</head>
<body class="bg-dark text-light">
    <!-- í—¤ë” -->
    <nav class="navbar navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-chart-line me-2"></i>
                Dantaro Central Dashboard
            </a>
            <div class="d-flex align-items-center">
                <span class="badge bg-success me-3" id="connection-status">
                    <i class="fas fa-wifi"></i> ì—°ê²° ì¤‘...
                </span>
                <span class="text-light" id="last-update">ì—…ë°ì´íŠ¸ ëŒ€ê¸° ì¤‘</span>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-3">
        <!-- ìƒíƒœ ê°œìš” -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="row">
                    <div class="col-md-3">
                        <div class="card bg-secondary text-light">
                            <div class="card-body text-center">
                                <h5><i class="fas fa-exchange-alt text-primary"></i> í™œì„± ê±°ë˜ì†Œ</h5>
                                <h2 id="active-exchanges">4</h2>
                                <small>OKX, Upbit, Coinone, Gate.io</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-secondary text-light">
                            <div class="card-body text-center">
                                <h5><i class="fas fa-coins text-warning"></i> ì¶”ì  ì‹¬ë³¼</h5>
                                <h2 id="tracked-symbols">0</h2>
                                <small>ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-secondary text-light">
                            <div class="card-body text-center">
                                <h5><i class="fas fa-chart-area text-success"></i> ì°¨ìµê±°ë˜ ê¸°íšŒ</h5>
                                <h2 id="arbitrage-count">0</h2>
                                <small>í˜„ì¬ í™œì„± ê¸°íšŒ</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-secondary text-light">
                            <div class="card-body text-center">
                                <h5><i class="fas fa-flag text-info"></i> ê¹€ì¹˜ í”„ë¦¬ë¯¸ì—„</h5>
                                <h2 id="kimchi-count">0</h2>
                                <small>í”„ë¦¬ë¯¸ì—„ ê¸°íšŒ</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- ì‹¤ì‹œê°„ ê°€ê²© í…Œì´ë¸” -->
            <div class="col-lg-6 mb-4">
                <div class="card bg-secondary text-light">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-dollar-sign text-warning"></i> ì‹¤ì‹œê°„ ê°€ê²©</h5>
                        <small id="price-update-time">ì—…ë°ì´íŠ¸ ëŒ€ê¸° ì¤‘</small>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                            <table class="table table-dark table-striped table-hover mb-0">
                                <thead class="table-primary sticky-top">
                                    <tr>
                                        <th>ê±°ë˜ì†Œ</th>
                                        <th>ì‹¬ë³¼</th>
                                        <th>ê°€ê²©</th>
                                        <th>ê±°ë˜ëŸ‰</th>
                                        <th>ë³€í™”</th>
                                    </tr>
                                </thead>
                                <tbody id="price-table-body">
                                    <tr>
                                        <td colspan="5" class="text-center text-muted">
                                            <i class="fas fa-spinner fa-spin"></i> ë°ì´í„° ë¡œë”© ì¤‘...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ì°¨ìµê±°ë˜ ê¸°íšŒ -->
            <div class="col-lg-6 mb-4">
                <div class="card bg-secondary text-light">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-chart-line text-success"></i> ì°¨ìµê±°ë˜ ê¸°íšŒ</h5>
                        <small id="arbitrage-update-time">ì—…ë°ì´íŠ¸ ëŒ€ê¸° ì¤‘</small>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                            <table class="table table-dark table-striped table-hover mb-0">
                                <thead class="table-success sticky-top">
                                    <tr>
                                        <th>ì‹¬ë³¼</th>
                                        <th>ë§¤ìˆ˜</th>
                                        <th>ë§¤ë„</th>
                                        <th>ìŠ¤í”„ë ˆë“œ</th>
                                        <th>ì‹ ë¢°ë„</th>
                                    </tr>
                                </thead>
                                <tbody id="arbitrage-table-body">
                                    <tr>
                                        <td colspan="5" class="text-center text-muted">
                                            <i class="fas fa-search"></i> ê¸°íšŒ íƒìƒ‰ ì¤‘...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ê¹€ì¹˜ í”„ë¦¬ë¯¸ì—„ -->
        <div class="row">
            <div class="col-12 mb-4">
                <div class="card bg-secondary text-light">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-flag text-info"></i> ê¹€ì¹˜ í”„ë¦¬ë¯¸ì—„</h5>
                        <small id="kimchi-update-time">ì—…ë°ì´íŠ¸ ëŒ€ê¸° ì¤‘</small>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-dark table-striped table-hover mb-0">
                                <thead class="table-info">
                                    <tr>
                                        <th>ì‹¬ë³¼</th>
                                        <th>í•œêµ­ ê±°ë˜ì†Œ</th>
                                        <th>ê¸€ë¡œë²Œ ê±°ë˜ì†Œ</th>
                                        <th>í•œêµ­ ê°€ê²©</th>
                                        <th>ê¸€ë¡œë²Œ ê°€ê²©</th>
                                        <th>í”„ë¦¬ë¯¸ì—„ (%)</th>
                                        <th>ìƒíƒœ</th>
                                    </tr>
                                </thead>
                                <tbody id="kimchi-table-body">
                                    <tr>
                                        <td colspan="7" class="text-center text-muted">
                                            <i class="fas fa-chart-bar"></i> í”„ë¦¬ë¯¸ì—„ ê³„ì‚° ì¤‘...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ì‹¤ì‹œê°„ ì°¨íŠ¸ -->
        <div class="row">
            <div class="col-lg-6 mb-4">
                <div class="card bg-secondary text-light">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-area text-primary"></i> ìŠ¤í”„ë ˆë“œ íˆìŠ¤í† ë¦¬</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="spread-chart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-6 mb-4">
                <div class="card bg-secondary text-light">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-line text-info"></i> ê¹€ì¹˜ í”„ë¦¬ë¯¸ì—„ íˆìŠ¤í† ë¦¬</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="kimchi-chart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- ë¡œê·¸ ë° ì•Œë¦¼ -->
        <div class="row">
            <div class="col-12 mb-4">
                <div class="card bg-secondary text-light">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-bell text-warning"></i> ì‹¤ì‹œê°„ ì•Œë¦¼</h5>
                        <div>
                            <button class="btn btn-sm btn-success me-2" onclick="testDashboardStatus()">
                                <i class="fas fa-check"></i> ìƒíƒœ í™•ì¸
                            </button>
                            <button class="btn btn-sm btn-info me-2" onclick="forceUpdateData()">
                                <i class="fas fa-sync"></i> ê°•ì œ ì—…ë°ì´íŠ¸
                            </button>
                            <button class="btn btn-sm btn-warning me-2" onclick="sendTestData()">
                                <i class="fas fa-paper-plane"></i> í…ŒìŠ¤íŠ¸ ì „ì†¡
                            </button>
                            <button class="btn btn-sm btn-danger me-2" onclick="sendRealData()">
                                <i class="fas fa-rocket"></i> ì‹¤ì œ ë°ì´í„°
                            </button>
                            <button class="btn btn-sm btn-purple me-2" onclick="startRealDataStream()">
                                <i class="fas fa-play"></i> ì‹¤ì‹œê°„ ì‹œì‘
                            </button>
                            <button class="btn btn-sm btn-dark me-2" onclick="stopRealDataStream()">
                                <i class="fas fa-stop"></i> ì‹¤ì‹œê°„ ì¤‘ì§€
                            </button>
                            <button class="btn btn-sm btn-primary me-2" onclick="testCharts()">
                                <i class="fas fa-chart-line"></i> ì°¨íŠ¸ í™•ì¸
                            </button>
                            <button class="btn btn-sm btn-outline-light" onclick="clearLogs()">
                                <i class="fas fa-trash"></i> ì§€ìš°ê¸°
                            </button>
                        </div>
                    </div>
                    <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                        <div id="log-container">
                            <div class="text-muted text-center">
                                <i class="fas fa-clock"></i> ì•Œë¦¼ ëŒ€ê¸° ì¤‘...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ì¶”ê°€ ì •ë³´ ì„¹ì…˜ -->
        <div class="row">
            <div class="col-12 mb-4">
                <div class="card bg-secondary text-light">
                    <div class="card-header">
                        <h5><i class="fas fa-info-circle text-primary"></i> ì¶”ê°€ ì •ë³´</h5>
                    </div>
                    <div class="card-body">
                        <section>
                            <h6>API ìƒíƒœ</h6>
                            <ul>
                                <li><a href="/health" target="_blank">/health (í—¬ìŠ¤ì²´í¬)</a></li>
                                <li><a href="/api/v1/recommendations" target="_blank">/api/v1/recommendations (API ì¸ì¦ í•„ìš”)</a></li>
                                <li><a href="/metrics" target="_blank">/metrics (Prometheus)</a></li>
                                <li><a href="/docs" target="_blank">/docs (Swagger UI)</a></li>
                            </ul>
                        </section>
                        <section>
                            <h6>ëª¨ë‹ˆí„°ë§</h6>
                            <ul>
                                <li><a href="http://localhost:9090" target="_blank">Prometheus ëŒ€ì‹œë³´ë“œ</a></li>
                                <li><a href="http://localhost:3000" target="_blank">Grafana ëŒ€ì‹œë³´ë“œ</a></li>
                            </ul>
                        </section>
                        <section>
                            <h6>ì‹œìŠ¤í…œ ì •ë³´</h6>
                            <div id="system-info">
                                <em>APIì—ì„œ ì‹¤ì‹œê°„ ìƒíƒœë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</em>
                            </div>
                        </section>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ì—°ê²° ìƒíƒœ ëª¨ë‹¬ -->
    <div class="modal fade" id="connectionModal" tabindex="-1">
        <div class="modal-dialog modal-sm">
            <div class="modal-content bg-dark text-light">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">ì—°ê²° ìƒíƒœ</h5>
                </div>
                <div class="modal-body text-center">
                    <div id="modal-status-content">
                        <i class="fas fa-spinner fa-spin fa-2x text-primary mb-3"></i>
                        <p>WebSocket ì—°ê²° ì¤‘...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- ë°ì´í„° ì–´ëŒ‘í„° ë¨¼ì € ë¡œë“œ -->
    <script src="/static/js/adapter.js?v=20250704-2"></script>
    <!-- ëŒ€ì‹œë³´ë“œ ë©”ì¸ ìŠ¤í¬ë¦½íŠ¸ -->
    <script src="/static/js/dashboard.js?v=20250704-2"></script>
    <script>
    console.log('ğŸ”¥ ìŠ¤í¬ë¦½íŠ¸ ì‹œì‘!');
    
    // ì¦‰ì‹œ í…ŒìŠ¤íŠ¸
    console.log('ì–´ëŒ‘í„° í™•ì¸:', typeof window.DantaroAdapter);
    console.log('ëŒ€ì‹œë³´ë“œ í´ë˜ìŠ¤ í™•ì¸:', typeof DantaroDashboard);
    
    // ëŒ€ì‹œë³´ë“œ ì´ˆê¸°í™”
    let dashboard = null;
    let initializationAttempted = false;
    
    function initDashboard() {
        if (initializationAttempted) {
            console.log('ğŸ”„ ì´ë¯¸ ì´ˆê¸°í™” ì‹œë„ë¨ - ê±´ë„ˆë›°ê¸°');
            return;
        }
        
        initializationAttempted = true;
        console.log('ğŸš€ ëŒ€ì‹œë³´ë“œ ê°•ì œ ì´ˆê¸°í™”!');
        try {
            // ê¸°ì¡´ ì¸ìŠ¤í„´ìŠ¤ê°€ ìˆë‹¤ë©´ ì •ë¦¬
            if (window.dashboard && typeof window.dashboard.disconnect === 'function') {
                window.dashboard.disconnect();
            }
            
            dashboard = new DantaroDashboard();
            window.dashboard = dashboard; // ì „ì—­ ì°¸ì¡° ì €ì¥
            console.log('âœ… ëŒ€ì‹œë³´ë“œ ìƒì„± ì„±ê³µ');
        } catch (error) {
            console.error('âŒ ëŒ€ì‹œë³´ë“œ ìƒì„± ì‹¤íŒ¨:', error);
            initializationAttempted = false; // ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„ í—ˆìš©
        }
    }
    
    // ì—¬ëŸ¬ ë°©ë²•ìœ¼ë¡œ ì´ˆê¸°í™” ì‹œë„
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initDashboard);
    } else {
        // DOMì´ ì´ë¯¸ ë¡œë“œëœ ê²½ìš°
        initDashboard();
    }
    
    // ë°±ì—… ì´ˆê¸°í™” (2ì´ˆ í›„)
    setTimeout(() => {
        if (!dashboard) {
            console.log('âš¡ ë°±ì—… ì´ˆê¸°í™” ì‹œë„');
            initDashboard();
        }
    }, 2000);
    
    // ì‹œìŠ¤í…œ ì •ë³´ ë¡œë“œ
    fetch('/health').then(r => r.json()).then(data => {
        document.getElementById('system-info').innerHTML =
            `<b>ìƒíƒœ:</b> ${data.api_server} <br><b>ë°ì´í„°ë² ì´ìŠ¤:</b> ${data.database.status}`;
    }).catch(() => {
        document.getElementById('system-info').innerHTML = '<span style="color:red">API ì—°ê²° ì‹¤íŒ¨</span>';
    });
    
    // ë²„íŠ¼ í´ë¦­ í•¨ìˆ˜ë“¤
    window.testDashboardStatus = function() {
        console.log('=== ëŒ€ì‹œë³´ë“œ ìƒíƒœ í™•ì¸ ===');
        if (window.dashboard) {
            console.log('âœ… ëŒ€ì‹œë³´ë“œ ì¸ìŠ¤í„´ìŠ¤ ì¡´ì¬');
            console.log('ê°€ê²© ë°ì´í„°:', window.dashboard.priceData.size);
            console.log('ì°¨ìµê±°ë˜ ë°ì´í„°:', window.dashboard.arbitrageData.length);
            console.log('ê¹€ì¹˜ í”„ë¦¬ë¯¸ì—„ ë°ì´í„°:', window.dashboard.kimchiData.length);
            console.log('WebSocket ìƒíƒœ:', window.dashboard.ws ? window.dashboard.ws.readyState : 'none');
            
            // ë¡œê·¸ì—ë„ í‘œì‹œ
            const logContainer = document.getElementById('log-container');
            if (logContainer) {
                logContainer.innerHTML = `
                    <div class="alert alert-info">
                        <strong>ëŒ€ì‹œë³´ë“œ ìƒíƒœ:</strong><br>
                        ê°€ê²© ë°ì´í„°: ${window.dashboard.priceData.size}ê°œ<br>
                        ì°¨ìµê±°ë˜: ${window.dashboard.arbitrageData.length}ê°œ<br>
                        ê¹€ì¹˜ í”„ë¦¬ë¯¸ì—„: ${window.dashboard.kimchiData.length}ê°œ<br>
                        WebSocket: ${window.dashboard.ws ? 'ì—°ê²°ë¨' : 'ì—†ìŒ'}
                    </div>
                `;
            }
        } else {
            console.log('âŒ ëŒ€ì‹œë³´ë“œ ì¸ìŠ¤í„´ìŠ¤ ì—†ìŒ');
            const logContainer = document.getElementById('log-container');
            if (logContainer) {
                logContainer.innerHTML = '<div class="alert alert-danger">âŒ ëŒ€ì‹œë³´ë“œ ì¸ìŠ¤í„´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
            }
        }
    };
    
    window.forceUpdateData = function() {
        console.log('ğŸ”„ ê°•ì œ ë°ì´í„° ì—…ë°ì´íŠ¸');
        if (window.dashboard) {
            // ê°•ì œë¡œ í…ŒìŠ¤íŠ¸ ë°ì´í„° ì„¤ì •
            window.dashboard.arbitrageData = [
                {
                    symbol: 'BTC',
                    buy_exchange: 'OKX',
                    sell_exchange: 'Upbit', 
                    buy_price: 95000,
                    sell_price: 97000,
                    spread_percentage: 2.1,
                    confidence: 0.85,
                    volume: 500000
                }
            ];
            
            window.dashboard.kimchiData = [
                {
                    symbol: 'BTC',
                    korean_exchange: 'Upbit',
                    global_exchange: 'OKX',
                    korean_price: 97000,
                    global_price: 95000,
                    premium_percentage: 2.1,
                    status: 'positive'
                }
            ];
            
            // UI ì—…ë°ì´íŠ¸
            window.dashboard.updateArbitrageTable();
            window.dashboard.updateKimchiTable();
            window.dashboard.updateStats();
            
            // ì°¨íŠ¸ ì—…ë°ì´íŠ¸
            window.dashboard.updateSpreadChart();
            window.dashboard.updateKimchiChart();
            
            console.log('âœ… ê°•ì œ ì—…ë°ì´íŠ¸ ì™„ë£Œ (ì°¨íŠ¸ í¬í•¨)');
            
            const logContainer = document.getElementById('log-container');
            if (logContainer) {
                logContainer.innerHTML = '<div class="alert alert-success">âœ… ê°•ì œ ë°ì´í„° ì—…ë°ì´íŠ¸ ì™„ë£Œ</div>';
            }
        } else {
            console.log('âŒ ëŒ€ì‹œë³´ë“œ ì¸ìŠ¤í„´ìŠ¤ ì—†ìŒ');
        }
    };
    
    window.sendTestData = function() {
        console.log('ğŸ“¡ í…ŒìŠ¤íŠ¸ ë°ì´í„° ì „ì†¡');
        fetch('/api/websocket/broadcast-test-data', {method: 'POST'})
            .then(response => response.json())
            .then(data => {
                console.log('âœ… í…ŒìŠ¤íŠ¸ ë°ì´í„° ì „ì†¡ ê²°ê³¼:', data);
                const logContainer = document.getElementById('log-container');
                if (logContainer) {
                    logContainer.innerHTML = `<div class="alert alert-success">ğŸ“¡ ${data.message || 'í…ŒìŠ¤íŠ¸ ë°ì´í„° ì „ì†¡ ì™„ë£Œ'}</div>`;
                }
            })
            .catch(error => {
                console.error('âŒ í…ŒìŠ¤íŠ¸ ë°ì´í„° ì „ì†¡ ì˜¤ë¥˜:', error);
                const logContainer = document.getElementById('log-container');
                if (logContainer) {
                    logContainer.innerHTML = '<div class="alert alert-danger">âŒ í…ŒìŠ¤íŠ¸ ë°ì´í„° ì „ì†¡ ì‹¤íŒ¨</div>';
                }
            });
    };
    
    window.testCharts = function() {
        console.log('=== ì°¨íŠ¸ ìƒíƒœ í™•ì¸ ===');
        if (window.dashboard) {
            console.log('ìŠ¤í”„ë ˆë“œ ì°¨íŠ¸:', !!window.dashboard.spreadChart);
            console.log('ê¹€ì¹˜ ì°¨íŠ¸:', !!window.dashboard.kimchiChart);
            
            if (window.dashboard.spreadChart) {
                console.log('ìŠ¤í”„ë ˆë“œ ì°¨íŠ¸ ë°ì´í„° ìˆ˜:', window.dashboard.spreadChart.data.labels.length);
            }
            if (window.dashboard.kimchiChart) {
                console.log('ê¹€ì¹˜ ì°¨íŠ¸ ë°ì´í„° ìˆ˜:', window.dashboard.kimchiChart.data.labels.length);
            }
            
            // ê°•ì œë¡œ ì°¨íŠ¸ì— ë°ì´í„° ì¶”ê°€
            if (window.dashboard.arbitrageData.length > 0) {
                console.log('ğŸ”„ ìŠ¤í”„ë ˆë“œ ì°¨íŠ¸ ê°•ì œ ì—…ë°ì´íŠ¸');
                window.dashboard.updateSpreadChart();
            }
            
            if (window.dashboard.kimchiData.length > 0) {
                console.log('ğŸ”„ ê¹€ì¹˜ ì°¨íŠ¸ ê°•ì œ ì—…ë°ì´íŠ¸');
                window.dashboard.updateKimchiChart();
            }
        } else {
            console.log('âŒ ëŒ€ì‹œë³´ë“œ ì¸ìŠ¤í„´ìŠ¤ ì—†ìŒ');
        }
    };
    </script>
</body>
</html>
